---
- name: Remove password lines from bash history
  hosts: all
  become: yes
  gather_facts: no

  tasks:
    - name: Find all bash history files
      find:
        paths:
          - /home
          - /root
        patterns: ".bash_history*"
        hidden: yes
        file_type: file
        recurse: yes
      register: history_files

    - name: Remove lines containing password keywords from bash history files
      lineinfile:
        path: "{{ item.path }}"
        regexp: '.*(?i)(password|passwd|pwd|pass=|--password|-p\s|secret|token|key=).*'
        state: absent
        backup: no
      loop: "{{ history_files.files }}"
      register: cleaned_files
      failed_when: false

    - name: Clear in-memory bash history
      shell: |
        pkill -USR1 bash 2>/dev/null || true
        for pid in $(pgrep bash 2>/dev/null); do
          echo "history -c" > /proc/$pid/fd/0 2>/dev/null || true
        done

    - name: Display summary
      debug:
        msg: "Processed {{ history_files.files | length }} bash history files. Removed password-containing lines while preserving other commands."
~
